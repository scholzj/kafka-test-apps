version: 2.1
jobs:
  build:
    resource_class: medium
    environment:
      USER: scholzj
      DOCKER_CLI_EXPERIMENTAL: enabled
      DOCKER_BUILDKIT: 1
      DOCKER_REGISTRY: ghcr.io
      MVN_ARGS: -e -V -B
    docker:
      - image: scholzj/circleci-centos-java:latest-java17
    steps:
      - setup_remote_docker:
          version: 20.10.7
      - checkout
      - run:
          name: Build code
          command: make build
      - run:
          name: Login to Docker Hub
          command: docker login ghcr.io -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD"
      - run:
          name: Build Docker images
          command: make docker_build
          environment:
            - DOCKER_ARCHITECTURE: amd64
      - run:
          name: Build Docker images
          command: make docker_build
          environment:
            - DOCKER_ARCHITECTURE: arm64
      - deploy:
          name: Push to Docker hub
          command: make docker_push
          environment:
            - DOCKER_ARCHITECTURE: amd64
      - deploy:
          name: Push to Docker hub
          command: make docker_push
          environment:
            - DOCKER_ARCHITECTURE: arm64
      - deploy:
          name: Push to Docker hub
          command: make docker_amend_manifest
          environment:
            - DOCKER_ARCHITECTURE: amd64
      - deploy:
          name: Push to Docker hub
          command: make docker_amend_manifest
          environment:
            - DOCKER_ARCHITECTURE: arm64
      - deploy:
          name: Push to Docker hub
          command: make docker_push_manifest
workflows:
  build-workflow:
    jobs:
      - build:
            context: ghcr.io